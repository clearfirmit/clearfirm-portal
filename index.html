<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearFirm Business Intelligence Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        .gradient-text {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #1f2937;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .risk-low { background-color: #10b981; }
        .risk-medium { background-color: #f59e0b; }
        .risk-high { background-color: #ef4444; }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Brand colors based on ClearFirm guidelines */
        .clearfirm-green { color: #6B7B3A; }
        .clearfirm-green-bg { background-color: #6B7B3A; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Login Screen -->
        <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200">
            <div class="max-w-md w-full">
                <div class="bg-white shadow-xl rounded-lg p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold gradient-text mb-2">ClearFirm</h1>
                        <p class="text-gray-600">Business Intelligence Portal</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input id="email" name="email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                        </div>
                        
                        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>
                        
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                            Sign In to Portal
                        </button>
                    </form>
                    
                    <div class="mt-8 text-center">
                        <div class="text-sm text-gray-600">
                            <p>Need access? Contact sales@getclearfirm.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="mainDashboard" class="hidden">
            <!-- Navigation -->
            <nav class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <h1 class="text-2xl font-bold gradient-text">ClearFirm</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="userEmail" class="text-sm text-gray-600"></span>
                            <button onclick="logout()" class="text-sm text-gray-600 hover:text-gray-900">Logout</button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Tab Navigation -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="switchTab('search')" id="searchTab" class="tab-button py-2 px-1 border-b-2 font-medium text-sm">
                            Business Search
                        </button>
                        <button onclick="switchTab('queue')" id="queueTab" class="tab-button py-2 px-1 border-b-2 font-medium text-sm">
                            My Queue
                        </button>
                        <button onclick="switchTab('portfolio')" id="portfolioTab" class="tab-button py-2 px-1 border-b-2 font-medium text-sm">
                            Portfolio Analytics
                        </button>
                        <button onclick="switchTab('admin')" id="adminTab" class="tab-button hidden py-2 px-1 border-b-2 font-medium text-sm">
                            Admin Portal
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Search Tab -->
                <div id="searchContent" class="tab-content">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Search for Business Intelligence</h2>
                        
                        <form id="searchForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="searchEIN" class="block text-sm font-medium text-gray-700">EIN</label>
                                    <input type="text" id="searchEIN" placeholder="XX-XXXXXXX" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                                </div>
                                <div>
                                    <label for="searchBusinessName" class="block text-sm font-medium text-gray-700">Business Name</label>
                                    <input type="text" id="searchBusinessName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full md:w-auto flex justify-center py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Request Verification
                            </button>
                        </form>
                        
                        <div id="searchResults" class="mt-8 hidden">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Search Results</h3>
                            <div id="resultsContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Queue Tab -->
                <div id="queueContent" class="tab-content hidden">
                    <div class="bg-white shadow rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Verification Queue</h2>
                        <div id="queueList" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Portfolio Tab -->
                <div id="portfolioContent" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-sm font-medium text-gray-500">Total Businesses</h3>
                            <p class="text-3xl font-bold text-gray-900 mt-2" id="totalBusinesses">0</p>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-sm font-medium text-gray-500">Average Risk Score</h3>
                            <p class="text-3xl font-bold text-gray-900 mt-2" id="avgRiskScore">0</p>
                        </div>
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-sm font-medium text-gray-500">High Risk Count</h3>
                            <p class="text-3xl font-bold text-red-600 mt-2" id="highRiskCount">0</p>
                        </div>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Portfolio Overview</h2>
                        <div id="portfolioList" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div id="adminContent" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Upload Form -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Upload Tax Transcript Data</h3>
                            
                            <form id="uploadForm" class="space-y-4">
                                <div>
                                    <label for="ein" class="block text-sm font-medium text-gray-700">EIN</label>
                                    <input type="text" id="ein" name="ein" placeholder="XX-XXXXXXX" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                                </div>
                                
                                <div>
                                    <label for="businessName" class="block text-sm font-medium text-gray-700">Business Name</label>
                                    <input type="text" id="businessName" name="businessName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500">
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Upload HTML Transcript Files</label>
                                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                        <div class="space-y-1 text-center">
                                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            <div class="flex text-sm text-gray-600">
                                                <label for="htmlFiles" class="relative cursor-pointer bg-white rounded-md font-medium text-gray-900 hover:text-gray-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-gray-500">
                                                    <span>Upload files</span>
                                                    <input id="htmlFiles" name="htmlFiles" type="file" class="sr-only" multiple accept=".html,.htm">
                                                </label>
                                                <p class="pl-1">or drag and drop</p>
                                            </div>
                                            <p class="text-xs text-gray-500">HTML files up to 10MB</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                    Process Transcript Data
                                </button>
                            </form>
                        </div>
                        
                        <!-- Data Extraction Preview -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Extraction Preview</h3>
                            <div id="extractionPreview" class="space-y-4">
                                <p class="text-sm text-gray-600">Upload HTML files to see extracted data fields</p>
                                
                                <div class="hidden" id="extractedFields">
                                    <div class="mb-4">
                                        <h4 class="font-medium text-sm mb-2">Basic Information:</h4>
                                        <div class="bg-gray-50 p-3 rounded text-xs space-y-1" id="basicInfo"></div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-sm mb-2">Financial Metrics:</h4>
                                        <div class="bg-gray-50 p-3 rounded text-xs space-y-1" id="financialMetrics"></div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-sm mb-2">Risk Assessment:</h4>
                                        <div class="bg-gray-50 p-3 rounded" id="riskAssessment"></div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button onclick="saveBusinessProfile()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm">
                                            Save Business Profile
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Processing Queue -->
                    <div class="mt-6 bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Admin Processing Queue</h3>
                        <div id="adminQueue" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tax Transcript Parser Class (integrated from Python)
        class TaxTranscriptParser {
            constructor() {
                this.fieldMappings = {
                    "1120S": {
                        "GROSS RECEIPTS": "gross_receipts",
                        "COST OF GOODS SOLD": "cost_of_goods_sold",
                        "TOTAL INCOME": "total_income",
                        "ORDINARY INCOME/LOSS": "ordinary_income_loss",
                        "COMPENSATION OF OFFICERS": "officer_compensation",
                        "SALARY & WAGES LESS JOBS CREDIT": "wages",
                        "TAXES & LICENSES": "taxes_licenses",
                        "INTEREST": "interest_expense",
                        "DEPRECIATION (NET)": "depreciation",
                        "EMPLOYEE BENEFIT PROGRAMS": "employee_benefits",
                        "PENSION/PROFIT SHARE PLANS": "pension_plans",
                        "OTHER DEDUCTIONS": "other_deductions",
                        "TOTAL DEDUCTIONS": "total_deductions",
                        "TOTAL ASSETS (END)": "total_assets_eoy",
                        "LOANS FROM SHAREHOLDERS END OF YEAR": "loans_from_shareholders",
                        "RETAINED EARNINGS END OF YEAR": "retained_earnings_eoy",
                        "CAPITAL STOCK END OF YEAR": "capital_stock",
                        "NUMBER OF SHAREHOLDERS": "num_shareholders",
                        "TAX YEAR BEGINNING": "tax_year_start",
                        "RECEIVED DATE": "return_received_date"
                    },
                    "1120": {
                        "GROSS RECEIPTS OR SALES": "gross_receipts",
                        "TAXABLE INCOME": "taxable_income",
                        "TOTAL TAX": "total_tax"
                    },
                    "1065": {
                        "GROSS RECEIPTS OR SALES": "gross_receipts",
                        "ORDINARY INCOME (LOSS)": "ordinary_income_loss"
                    }
                };
            }

            async parseTranscriptHTML(htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                let transcriptData = this.extractBasicInfo(doc);
                const formType = transcriptData.form_type || "";
                
                if (this.fieldMappings[formType]) {
                    const financialData = this.extractFinancialData(doc, formType);
                    Object.assign(transcriptData, financialData);
                }
                
                const additionalContext = this.extractAdditionalContext(doc);
                Object.assign(transcriptData, additionalContext);
                
                const derivedMetrics = this.calculateDerivedMetrics(transcriptData);
                Object.assign(transcriptData, derivedMetrics);
                
                return transcriptData;
            }

            extractBasicInfo(doc) {
                const data = {};
                
                // Try to extract from title first
                const title = doc.querySelector('title');
                if (title && title.textContent) {
                    // Parse: "Tax Return Transcript   XX-XXX6570   1120S   202212   BUSINESS NAME"
                    const titleText = title.textContent.trim();
                    const titleParts = titleText.split(/\s{2,}/); // Split by multiple spaces
                    
                    if (titleParts.length >= 4) {
                        // Extract EIN (should be in format XX-XXXXXXX)
                        const einPattern = /\d{2}-\d{7}/;
                        const einMatch = titleText.match(einPattern);
                        if (einMatch) {
                            data.ein = einMatch[0];
                        }
                        
                        // Extract form type (1120, 1120S, 1065, etc.)
                        const formPattern = /\b(1120S?|1065|1040|990)\b/;
                        const formMatch = titleText.match(formPattern);
                        if (formMatch) {
                            data.form_type = formMatch[0];
                        }
                        
                        // Extract tax period (YYYYMM format)
                        const periodPattern = /\b(20\d{4})\b/;
                        const periodMatch = titleText.match(periodPattern);
                        if (periodMatch) {
                            data.tax_period = periodMatch[0];
                            // Format the period
                            const year = periodMatch[0].substring(0, 4);
                            const month = periodMatch[0].substring(4, 6);
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            data.tax_period_formatted = `${monthNames[parseInt(month) - 1]}. 31, ${year}`;
                        }
                    }
                }
                
                // Extract from table rows - look for specific patterns
                const rows = doc.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const label = cells[0].textContent.trim().toUpperCase();
                        const value = cells[1].textContent.trim();
                        
                        // EIN patterns
                        if (label.includes("EIN PROVIDED") || label.includes("EMPLOYER IDENTIFICATION NUMBER")) {
                            if (value.match(/\d{2}-\d{7}/)) {
                                data.ein = value;
                            }
                        } 
                        // Tax period patterns
                        else if (label.includes("TAX PERIOD") || label.includes("TAX YEAR ENDING")) {
                            data.tax_period_formatted = value;
                            // Try to extract YYYYMM format
                            const yearMatch = value.match(/20\d{2}/);
                            if (yearMatch) {
                                const year = yearMatch[0];
                                const monthMatch = value.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
                                if (monthMatch) {
                                    const monthMap = {
                                        'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                        'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                        'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                                    };
                                    data.tax_period = year + monthMap[monthMatch[0]];
                                }
                            }
                        }
                        // Form type
                        else if (label.includes("FORM NUMBER") || label.includes("RETURN TYPE")) {
                            if (value.match(/1120S?|1065|1040|990/)) {
                                data.form_type = value.match(/1120S?|1065|1040|990/)[0];
                            }
                        }
                        // Business name
                        else if (label.includes("NAME") && (label.includes("SHOWN") || label.includes("RETURN"))) {
                            data.business_name = value;
                        }
                        // Address
                        else if (label.includes("ADDRESS") && !label.includes("FOREIGN")) {
                            data.address = value;
                        }
                    }
                });
                
                // Ensure we have valid data
                if (!data.form_type) {
                    // Try to detect form type from content
                    const bodyText = doc.body.textContent;
                    if (bodyText.includes("S CORPORATION")) {
                        data.form_type = "1120S";
                    } else if (bodyText.includes("C CORPORATION")) {
                        data.form_type = "1120";
                    } else if (bodyText.includes("PARTNERSHIP")) {
                        data.form_type = "1065";
                    }
                }
                
                return data;
            }

            extractFinancialData(doc, formType) {
                const data = {};
                const fieldMap = this.fieldMappings[formType] || {};
                
                const rows = doc.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const label = cells[0].textContent.trim().replace(':', '').toUpperCase();
                        const valueText = cells[1].textContent.trim();
                        
                        // Direct field mapping
                        for (const [transcriptField, dataField] of Object.entries(fieldMap)) {
                            if (label === transcriptField || label.includes(transcriptField)) {
                                const value = this.parseValue(valueText);
                                if (value !== null) {
                                    data[dataField] = value;
                                }
                                break;
                            }
                        }
                        
                        // Also check for common variations
                        if (label.includes("GROSS RECEIPTS") || label.includes("TOTAL RECEIPTS")) {
                            const value = this.parseValue(valueText);
                            if (value !== null) data.gross_receipts = value;
                        }
                        else if (label.includes("ORDINARY BUSINESS INCOME") || label.includes("ORDINARY INCOME")) {
                            const value = this.parseValue(valueText);
                            if (value !== null) data.ordinary_income_loss = value;
                        }
                        else if (label.includes("TOTAL ASSETS") && label.includes("END")) {
                            const value = this.parseValue(valueText);
                            if (value !== null) data.total_assets_eoy = value;
                        }
                        else if (label.includes("SALARIES") || label.includes("WAGES")) {
                            const value = this.parseValue(valueText);
                            if (value !== null && !data.wages) data.wages = value;
                        }
                    }
                });
                
                return data;
            }

            parseValue(valueText) {
                if (!valueText || valueText === "N/A") {
                    return null;
                }
                
                let cleaned = valueText.replace(/[$,]/g, '').trim();
                
                // Handle negative values in parentheses
                if (cleaned.startsWith('(') && cleaned.endsWith(')')) {
                    cleaned = '-' + cleaned.slice(1, -1);
                }
                
                try {
                    return parseFloat(cleaned);
                } catch (e) {
                    try {
                        return parseInt(cleaned);
                    } catch (e2) {
                        return null;
                    }
                }
            }

            extractAdditionalContext(doc) {
                const context = {};
                const textContent = doc.body.textContent;
                
                if (textContent.includes("Amendment") || textContent.includes("AMENDED RETURN")) {
                    context.has_amendments = true;
                }
                
                if (textContent.includes("ESTIMATED TAX PENALTY")) {
                    const rows = doc.querySelectorAll('tr');
                    rows.forEach(row => {
                        if (row.textContent.includes("ESTIMATED TAX PENALTY")) {
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 2) {
                                const penalty = this.parseValue(cells[1].textContent);
                                if (penalty && penalty > 0) {
                                    context.estimated_tax_penalty = penalty;
                                }
                            }
                        }
                    });
                }
                
                return context;
            }

            calculateDerivedMetrics(data) {
                const metrics = {};
                
                if (data.gross_receipts && data.cost_of_goods_sold) {
                    const grossProfit = data.gross_receipts - data.cost_of_goods_sold;
                    metrics.gross_margin_percent = (grossProfit / data.gross_receipts) * 100;
                }
                
                if (data.gross_receipts && data.ordinary_income_loss) {
                    metrics.operating_margin_percent = (data.ordinary_income_loss / data.gross_receipts) * 100;
                }
                
                if (data.loans_from_shareholders && data.total_assets_eoy) {
                    metrics.debt_to_asset_ratio = data.loans_from_shareholders / data.total_assets_eoy;
                }
                
                const wages = data.wages || 0;
                const officerComp = data.officer_compensation || 0;
                const benefits = data.employee_benefits || 0;
                const pension = data.pension_plans || 0;
                
                metrics.total_employment_costs = wages + officerComp + benefits + pension;
                
                if (metrics.total_employment_costs > 0) {
                    metrics.estimated_quarterly_941 = metrics.total_employment_costs * 0.153 / 4;
                }
                
                return metrics;
            }

            generateRiskAssessment(transcriptData) {
                const riskFactors = [];
                let riskScore = 0;
                const recommendations = [];
                
                if ((transcriptData.ordinary_income_loss || 0) < 0) {
                    riskFactors.push("Operating at a loss");
                    riskScore += 20;
                }
                
                if ((transcriptData.total_employment_costs || 0) > 100000 && (transcriptData.ordinary_income_loss || 0) < 0) {
                    riskFactors.push("High payroll costs with operating losses");
                    riskScore += 25;
                    recommendations.push("941/940 Payroll Tax Resolution");
                }
                
                if ((transcriptData.debt_to_asset_ratio || 0) > 0.7) {
                    riskFactors.push("High debt-to-asset ratio");
                    riskScore += 10;
                }
                
                if ((transcriptData.retained_earnings_eoy || 0) < -100000) {
                    riskFactors.push("Significant negative retained earnings");
                    riskScore += 15;
                    recommendations.push("Business tax debt resolution");
                }
                
                if (transcriptData.gross_receipts && transcriptData.interest_expense) {
                    const interestBurden = (transcriptData.interest_expense / transcriptData.gross_receipts) * 100;
                    if (interestBurden > 5) {
                        riskFactors.push(`Interest expense is ${interestBurden.toFixed(1)}% of revenue`);
                        riskScore += 10;
                    }
                }
                
                riskScore = Math.min(riskScore, 100);
                
                let riskLevel = "LOW";
                if (riskScore >= 70) riskLevel = "HIGH";
                else if (riskScore >= 40) riskLevel = "MEDIUM";
                
                // Estimate tax exposure
                let payrollTaxEstimate = 0;
                if (transcriptData.total_employment_costs && (transcriptData.ordinary_income_loss || 0) < 0) {
                    const quarterly941 = transcriptData.total_employment_costs * 0.153 / 4;
                    payrollTaxEstimate = quarterly941 * 2;
                }
                
                let incomeTaxEstimate = 0;
                if (transcriptData.form_type === "1120" && (transcriptData.total_tax || 0) > 0) {
                    incomeTaxEstimate = transcriptData.total_tax;
                }
                
                return {
                    risk_score: riskScore,
                    risk_level: riskLevel,
                    risk_factors: riskFactors,
                    recommendations: recommendations,
                    estimated_tax_exposure: {
                        payroll_tax_estimate: payrollTaxEstimate,
                        income_tax_estimate: incomeTaxEstimate,
                        total_estimate: payrollTaxEstimate + incomeTaxEstimate
                    }
                };
            }
        }

        // Initialize parser
        const parser = new TaxTranscriptParser();

        // Application State
        const state = {
            currentUser: null,
            businesses: [],
            queue: [],
            transcriptData: null,
            uploadedTranscripts: []
        };

        // Demo Data
        const users = {
            'affiniti@clearfirm.com': { password: 'demo123', role: 'client', name: 'Affiniti Finance' },
            'matt@getclearfirm.com': { password: 'admin123', role: 'admin', name: 'Matt Parker' }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check if logged in
            const savedUser = localStorage.getItem('clearfirm_user');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                showDashboard();
            }
            
            // Setup form handlers
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            
            // Setup file upload
            const fileInput = document.getElementById('htmlFiles');
            fileInput.addEventListener('change', handleFileSelect);
            
            // Setup drag and drop
            const dropZone = document.querySelector('.border-dashed');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-gray-400', 'bg-gray-50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-gray-400', 'bg-gray-50');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-gray-400', 'bg-gray-50');
                handleFileSelect({ target: { files: e.dataTransfer.files } });
            });
        });

        // Login Handler
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (users[email] && users[email].password === password) {
                state.currentUser = { email, ...users[email] };
                localStorage.setItem('clearfirm_user', JSON.stringify(state.currentUser));
                showDashboard();
            } else {
                document.getElementById('loginError').textContent = 'Invalid email or password';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('userEmail').textContent = state.currentUser.email;
            
            // Show admin tab if admin user
            if (state.currentUser.role === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            
            // Load data
            loadBusinesses();
            loadQueue();
            switchTab('search');
        }

        // Tab Switching
        function switchTab(tab) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Reset tab styles
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-gray-900', 'text-gray-900');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected content
            document.getElementById(`${tab}Content`).classList.remove('hidden');
            document.getElementById(`${tab}Tab`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`${tab}Tab`).classList.add('border-gray-900', 'text-gray-900');
            
            // Load tab-specific data
            if (tab === 'portfolio') {
                updatePortfolio();
            } else if (tab === 'admin') {
                updateAdminQueue();
            }
        }

        // Business Search
        function handleSearch(e) {
            e.preventDefault();
            const ein = document.getElementById('searchEIN').value;
            const businessName = document.getElementById('searchBusinessName').value;
            
            // Add to queue
            const request = {
                id: Date.now(),
                ein,
                businessName,
                status: 'pending',
                requestedBy: state.currentUser.email,
                requestedAt: new Date().toISOString()
            };
            
            state.queue.push(request);
            saveQueue();
            
            // Show confirmation
            document.getElementById('searchResults').classList.remove('hidden');
            document.getElementById('resultsContainer').innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-md p-4">
                    <p class="text-green-800">Verification request submitted successfully!</p>
                    <p class="text-sm text-green-600 mt-1">You'll receive the results within 30 minutes to 1 business day.</p>
                </div>
            `;
            
            // Clear form
            document.getElementById('searchForm').reset();
            
            // Refresh queue
            loadQueue();
        }

        // File Upload Handling
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            state.uploadedTranscripts = [];
            
            for (const file of files) {
                const content = await file.text();
                const transcriptData = await parser.parseTranscriptHTML(content);
                const riskAssessment = parser.generateRiskAssessment(transcriptData);
                
                state.uploadedTranscripts.push({
                    filename: file.name,
                    data: transcriptData,
                    riskAssessment
                });
            }
            
            displayExtractedData();
        }

        function displayExtractedData() {
            if (state.uploadedTranscripts.length === 0) return;
            
            document.getElementById('extractedFields').classList.remove('hidden');
            
            // Display basic info from first transcript
            const transcript = state.uploadedTranscripts[0];
            const data = transcript.data;
            const risk = transcript.riskAssessment;
            
            // Basic Information
            document.getElementById('basicInfo').innerHTML = `
                <div>Form Type: <strong>${data.form_type || 'N/A'}</strong></div>
                <div>Tax Period: <strong>${data.tax_period_formatted || data.tax_period || 'N/A'}</strong></div>
                <div>Business Name: <strong>${data.business_name || 'N/A'}</strong></div>
                <div>EIN: <strong>${data.ein || 'N/A'}</strong></div>
                <div>Address: <strong>${data.address || 'N/A'}</strong></div>
            `;
            
            // Financial Metrics
            document.getElementById('financialMetrics').innerHTML = `
                <div>Gross Receipts: <strong>${formatCurrency(data.gross_receipts)}</strong></div>
                <div>Operating Income/Loss: <strong class="${(data.ordinary_income_loss || 0) < 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(data.ordinary_income_loss)}</strong></div>
                <div>Total Assets: <strong>${formatCurrency(data.total_assets_eoy)}</strong></div>
                <div>Total Employment Costs: <strong>${formatCurrency(data.total_employment_costs)}</strong></div>
                <div>Gross Margin: <strong>${data.gross_margin_percent ? data.gross_margin_percent.toFixed(1) + '%' : 'N/A'}</strong></div>
                <div>Operating Margin: <strong>${data.operating_margin_percent ? data.operating_margin_percent.toFixed(1) + '%' : 'N/A'}</strong></div>
            `;
            
            // Risk Assessment
            const riskClass = risk.risk_level === 'HIGH' ? 'text-red-600' : risk.risk_level === 'MEDIUM' ? 'text-yellow-600' : 'text-green-600';
            document.getElementById('riskAssessment').innerHTML = `
                <div class="mb-2">
                    <span class="text-sm">Risk Score: </span>
                    <span class="font-bold text-lg ${riskClass}">${risk.risk_score}/100</span>
                    <span class="ml-2 px-2 py-1 rounded text-xs font-medium ${risk.risk_level === 'HIGH' ? 'bg-red-100 text-red-800' : risk.risk_level === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                        ${risk.risk_level} RISK
                    </span>
                </div>
                ${risk.risk_factors.length > 0 ? `
                    <div class="text-xs">
                        <div class="font-medium mb-1">Risk Factors:</div>
                        <ul class="list-disc list-inside space-y-1">
                            ${risk.risk_factors.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                <div class="mt-2 text-xs">
                    <div class="font-medium">Estimated Tax Exposure:</div>
                    <div>Total: <strong>${formatCurrency(risk.estimated_tax_exposure.total_estimate)}</strong></div>
                </div>
            `;
            
            // Update form fields if empty
            if (!document.getElementById('ein').value && data.ein) {
                document.getElementById('ein').value = data.ein;
            }
            if (!document.getElementById('businessName').value && data.business_name) {
                document.getElementById('businessName').value = data.business_name;
            }
        }

        // Handle Upload
        function handleUpload(e) {
            e.preventDefault();
            
            const ein = document.getElementById('ein').value.trim();
            const businessName = document.getElementById('businessName').value.trim();
            
            if (!ein || !businessName || state.uploadedTranscripts.length === 0) {
                alert('Please fill in all fields and upload at least one transcript');
                return;
            }
            
            // Find existing business by EIN (case-insensitive and trim spaces)
            let business = state.businesses.find(b => 
                b.ein && b.ein.trim().toUpperCase() === ein.trim().toUpperCase()
            );
            
            if (!business) {
                // Create new business entry
                business = {
                    id: Date.now(),
                    ein: ein,
                    businessName: businessName,
                    transcripts: [],
                    uploadedBy: state.currentUser.email,
                    uploadedAt: new Date().toISOString(),
                    status: 'verified'
                };
                state.businesses.push(business);
                console.log('Created new business:', business);
            } else {
                console.log('Found existing business:', business);
                // Update business name if different
                if (business.businessName !== businessName) {
                    business.businessName = businessName;
                }
            }
            
            // Initialize transcripts array if it doesn't exist
            if (!business.transcripts) {
                business.transcripts = [];
            }
            
            // Add transcripts to the business
            let addedCount = 0;
            state.uploadedTranscripts.forEach(transcript => {
                // Check if transcript for this period already exists
                const existingIndex = business.transcripts.findIndex(t => 
                    t.data && transcript.data && 
                    t.data.tax_period === transcript.data.tax_period
                );
                
                if (existingIndex >= 0) {
                    // Update existing transcript
                    business.transcripts[existingIndex] = transcript;
                    console.log('Updated existing transcript for period:', transcript.data.tax_period);
                } else {
                    // Add new transcript
                    business.transcripts.push(transcript);
                    addedCount++;
                    console.log('Added new transcript for period:', transcript.data.tax_period);
                }
            });
            
            // Calculate overall risk assessment based on latest transcript
            const sortedTranscripts = business.transcripts.sort((a, b) => {
                const periodA = a.data?.tax_period || '';
                const periodB = b.data?.tax_period || '';
                return periodB.localeCompare(periodA);
            });
            
            const latestTranscript = sortedTranscripts[0];
            
            if (latestTranscript && latestTranscript.data) {
                business.riskAssessment = latestTranscript.riskAssessment;
                // Copy key fields to business level for easy display
                business.gross_receipts = latestTranscript.data.gross_receipts;
                business.ordinary_income_loss = latestTranscript.data.ordinary_income_loss;
                business.tax_period = latestTranscript.data.tax_period;
                business.tax_period_formatted = latestTranscript.data.tax_period_formatted;
                business.form_type = latestTranscript.data.form_type;
            }
            
            // Update queue item if exists
            const queueItem = state.queue.find(q => q.ein === ein);
            if (queueItem) {
                queueItem.status = 'completed';
                queueItem.completedAt = new Date().toISOString();
            }
            
            // Remove any old duplicate entries for this EIN
            state.businesses = state.businesses.filter(b => 
                b.id === business.id || b.ein.trim().toUpperCase() !== ein.trim().toUpperCase()
            );
            
            saveBusinesses();
            saveQueue();
            
            // Clear form
            document.getElementById('uploadForm').reset();
            document.getElementById('extractedFields').classList.add('hidden');
            const uploadedCount = state.uploadedTranscripts.length;
            state.uploadedTranscripts = [];
            
            alert(`Successfully processed ${uploadedCount} transcript(s) for ${businessName}.\nTotal transcripts for this business: ${business.transcripts.length}`);
            updateAdminQueue();
            
            // If on portfolio tab, refresh it
            if (document.getElementById('portfolioContent').classList.contains('hidden') === false) {
                updatePortfolio();
            }
        }

        // Save Business Profile
        function saveBusinessProfile() {
            const ein = document.getElementById('ein').value;
            const businessName = document.getElementById('businessName').value;
            
            if (!ein || !businessName || state.uploadedTranscripts.length === 0) {
                alert('Please complete all fields before saving');
                return;
            }
            
            handleUpload({ preventDefault: () => {} });
        }

        // Load Data Functions
        function loadBusinesses() {
            const saved = localStorage.getItem('clearfirm_businesses');
            if (saved) {
                state.businesses = JSON.parse(saved);
            }
        }

        function loadQueue() {
            const saved = localStorage.getItem('clearfirm_queue');
            if (saved) {
                state.queue = JSON.parse(saved);
            }
            updateQueueDisplay();
        }

        function saveBusinesses() {
            localStorage.setItem('clearfirm_businesses', JSON.stringify(state.businesses));
        }

        function saveQueue() {
            localStorage.setItem('clearfirm_queue', JSON.stringify(state.queue));
        }

        // Update Queue Display
        function updateQueueDisplay() {
            const queueList = document.getElementById('queueList');
            const userQueue = state.queue.filter(q => q.requestedBy === state.currentUser.email);
            
            if (userQueue.length === 0) {
                queueList.innerHTML = '<p class="text-gray-500">No pending verification requests</p>';
                return;
            }
            
            queueList.innerHTML = userQueue.map(item => `
                <div class="border rounded-lg p-4 ${item.status === 'completed' ? 'bg-green-50' : 'bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium">${item.businessName}</h4>
                            <p class="text-sm text-gray-600">EIN: ${item.ein}</p>
                            <p class="text-xs text-gray-500">Requested: ${new Date(item.requestedAt).toLocaleString()}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            item.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${item.status === 'completed' ? 'Completed' : 'Pending'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Update Portfolio
        function updatePortfolio() {
            const verifiedBusinesses = state.businesses.filter(b => b.status === 'verified');
            
            // Update stats
            document.getElementById('totalBusinesses').textContent = verifiedBusinesses.length;
            
            if (verifiedBusinesses.length > 0) {
                const avgRisk = verifiedBusinesses.reduce((sum, b) => sum + (b.riskAssessment?.risk_score || 0), 0) / verifiedBusinesses.length;
                document.getElementById('avgRiskScore').textContent = avgRisk.toFixed(0);
                
                const highRisk = verifiedBusinesses.filter(b => b.riskAssessment?.risk_level === 'HIGH').length;
                document.getElementById('highRiskCount').textContent = highRisk;
            }
            
            // Update portfolio list
            const portfolioList = document.getElementById('portfolioList');
            
            if (verifiedBusinesses.length === 0) {
                portfolioList.innerHTML = '<p class="text-gray-500">No verified businesses in your portfolio</p>';
                return;
            }
            
            portfolioList.innerHTML = verifiedBusinesses.map(business => {
                const risk = business.riskAssessment || { risk_level: 'LOW', risk_score: 0 };
                const riskColorClass = risk.risk_level === 'HIGH' ? 'bg-red-100 text-red-800' : 
                                      risk.risk_level === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' : 
                                      'bg-green-100 text-green-800';
                
                // Get transcript count
                const transcriptCount = business.transcripts ? business.transcripts.length : 1;
                
                return `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="showBusinessDetails('${business.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-medium text-lg">${business.businessName}</h4>
                                <p class="text-sm text-gray-600">EIN: ${business.ein}</p>
                                <p class="text-xs text-gray-500">${transcriptCount} transcript(s) available</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${riskColorClass}">
                                ${risk.risk_level} RISK (${risk.risk_score}/100)
                            </span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Revenue</p>
                                <p class="font-medium">${formatCurrency(business.gross_receipts)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Operating Income</p>
                                <p class="font-medium ${(business.ordinary_income_loss || 0) < 0 ? 'text-red-600' : 'text-green-600'}">
                                    ${formatCurrency(business.ordinary_income_loss)}
                                </p>
                            </div>
                            <div>
                                <p class="text-gray-500">Tax Period</p>
                                <p class="font-medium">${business.tax_period_formatted || business.tax_period || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Est. Tax Exposure</p>
                                <p class="font-medium">${formatCurrency(risk.estimated_tax_exposure?.total_estimate || 0)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update Admin Queue
        function updateAdminQueue() {
            if (state.currentUser.role !== 'admin') return;
            
            const adminQueue = document.getElementById('adminQueue');
            const pendingQueue = state.queue.filter(q => q.status === 'pending');
            
            if (pendingQueue.length === 0) {
                adminQueue.innerHTML = '<p class="text-gray-500">No pending requests</p>';
                return;
            }
            
            adminQueue.innerHTML = pendingQueue.map(item => `
                <div class="border rounded-lg p-4 bg-yellow-50">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-medium">${item.businessName}</h4>
                            <p class="text-sm text-gray-600">EIN: ${item.ein}</p>
                            <p class="text-xs text-gray-500">Requested by: ${item.requestedBy}</p>
                            <p class="text-xs text-gray-500">Time: ${new Date(item.requestedAt).toLocaleString()}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                            Action Required
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Show Business Details
        function showBusinessDetails(businessId) {
            const business = state.businesses.find(b => b.id == businessId);
            if (!business) return;
            
            let detailsHTML = `
                <h3 class="text-xl font-bold mb-4">${business.businessName}</h3>
                <p class="text-gray-600 mb-4">EIN: ${business.ein}</p>
            `;
            
            if (business.transcripts && business.transcripts.length > 0) {
                detailsHTML += `<h4 class="font-semibold mb-3">Available Transcripts:</h4>`;
                
                // Sort transcripts by tax period
                const sortedTranscripts = [...business.transcripts].sort((a, b) => 
                    (b.data.tax_period || '').localeCompare(a.data.tax_period || '')
                );
                
                sortedTranscripts.forEach(transcript => {
                    const data = transcript.data;
                    const risk = transcript.riskAssessment;
                    
                    detailsHTML += `
                        <div class="border rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="font-medium">
                                    ${data.form_type || 'Unknown Form'} - ${data.tax_period_formatted || data.tax_period || 'N/A'}
                                </h5>
                                <span class="px-2 py-1 rounded text-xs font-medium ${
                                    risk.risk_level === 'HIGH' ? 'bg-red-100 text-red-800' : 
                                    risk.risk_level === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' : 
                                    'bg-green-100 text-green-800'
                                }">
                                    ${risk.risk_level} (${risk.risk_score}/100)
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Gross Receipts:</span>
                                    <span class="ml-2 font-medium">${formatCurrency(data.gross_receipts)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Operating Income:</span>
                                    <span class="ml-2 font-medium ${(data.ordinary_income_loss || 0) < 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${formatCurrency(data.ordinary_income_loss)}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Total Assets:</span>
                                    <span class="ml-2 font-medium">${formatCurrency(data.total_assets_eoy)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Est. Tax Exposure:</span>
                                    <span class="ml-2 font-medium">${formatCurrency(risk.estimated_tax_exposure?.total_estimate || 0)}</span>
                                </div>
                            </div>
                            
                            ${risk.risk_factors.length > 0 ? `
                                <div class="mt-3 text-sm">
                                    <span class="font-medium">Risk Factors:</span>
                                    <ul class="list-disc list-inside mt-1 text-gray-600">
                                        ${risk.risk_factors.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                // Legacy format for businesses without transcript array
                detailsHTML += `<pre class="bg-gray-100 p-4 rounded overflow-auto text-xs">${JSON.stringify(business, null, 2)}</pre>`;
            }
            
            // Show in alert for now - in production this would be a modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-auto p-6">
                    ${detailsHTML}
                    <button onclick="this.closest('.fixed').remove()" class="mt-4 px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Utility Functions
        function formatCurrency(value) {
            if (value === null || value === undefined) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function logout() {
            localStorage.removeItem('clearfirm_user');
            location.reload();
        }
    </script>
</body>
</html>